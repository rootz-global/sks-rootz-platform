<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email DATA_WALLET Authorization</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2563eb;
            color: white;
            padding: 30px;
            text-align: center;
        }
        .content {
            padding: 30px;
        }
        .wallet-status {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #e5e7eb;
        }
        .wallet-connected {
            background: #dcfce7;
            border-color: #22c55e;
            color: #15803d;
        }
        .wallet-disconnected {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }
        .auth-request {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .email-preview {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 5px;
        }
        .button-primary {
            background: #2563eb;
            color: white;
        }
        .button-primary:hover {
            background: #1d4ed8;
        }
        .button-danger {
            background: #dc2626;
            color: white;
        }
        .button-danger:hover {
            background: #b91c1c;
        }
        .button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status-success {
            background: #dcfce7;
            color: #15803d;
        }
        .status-error {
            background: #fef2f2;
            color: #dc2626;
        }
        .status-info {
            background: #dbeafe;
            color: #1d4ed8;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .ipfs-link {
            word-break: break-all;
            color: #2563eb;
            text-decoration: none;
        }
        .ipfs-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Email DATA_WALLET Authorization</h1>
            <p>Review and authorize creation of blockchain-verified email wallets</p>
        </div>
        
        <div class="content">
            <!-- Wallet Connection Status -->
            <div id="walletStatus" class="wallet-status wallet-disconnected">
                <h3>MetaMask Connection</h3>
                <p id="walletStatusText">Connect your MetaMask wallet to authorize email wallet creation</p>
                <button id="connectWallet" class="button button-primary">Connect MetaMask</button>
            </div>

            <!-- Authorization Requests -->
            <div id="authRequests">
                <h3>Pending Authorization Requests</h3>
                <div id="requestsList">
                    <p>Loading authorization requests...</p>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="statusMessages"></div>
        </div>
    </div>

    <script>
        let provider, signer, userAddress;
        const API_BASE = `${window.location.origin}/.rootz`;

        // Connect MetaMask
        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    
                    // Verify network (Polygon Amoy)
                    const network = await provider.getNetwork();
                    if (network.chainId !== 80002) {
                        showStatus('Please switch to Polygon Amoy testnet (Chain ID: 80002) in MetaMask.', 'error');
                        return;
                    }
                    
                    updateWalletStatus(true);
                    loadAuthorizationRequests();
                } else {
                    showStatus('MetaMask not found. Please install MetaMask extension.', 'error');
                }
            } catch (error) {
                console.error('Failed to connect wallet:', error);
                showStatus('Failed to connect MetaMask: ' + error.message, 'error');
            }
        }

        // Update wallet connection status
        function updateWalletStatus(connected) {
            const statusDiv = document.getElementById('walletStatus');
            const statusText = document.getElementById('walletStatusText');
            const connectButton = document.getElementById('connectWallet');

            if (connected) {
                statusDiv.className = 'wallet-status wallet-connected';
                statusText.textContent = `Connected: ${userAddress}`;
                connectButton.textContent = 'Connected ✓';
                connectButton.disabled = true;
            } else {
                statusDiv.className = 'wallet-status wallet-disconnected';
                statusText.textContent = 'Connect your MetaMask wallet to authorize email wallet creation';
                connectButton.textContent = 'Connect MetaMask';
                connectButton.disabled = false;
            }
        }

        // Load authorization requests for connected wallet - FIXED API ENDPOINTS
        async function loadAuthorizationRequests() {
            if (!userAddress) return;

            try {
                showStatus('Loading your authorization requests...', 'info');
                
                // Call Enhanced Authorization Service API to get user's pending requests
                const response = await fetch(`${API_BASE}/authorization/user-requests/${userAddress}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.requests && data.data.requests.length > 0) {
                    displayAuthorizationRequests(data.data.requests);
                    clearStatus();
                } else {
                    document.getElementById('requestsList').innerHTML = `
                        <p>No pending authorization requests found.</p>
                        <p>Send an email to <strong>process@rivetz.com</strong> with your wallet address <code>${userAddress}</code> to create an authorization request.</p>
                        <p><small>Example: "Please create a DATA_WALLET for my address: ${userAddress}"</small></p>
                    `;
                    clearStatus();
                }
            } catch (error) {
                console.error('Failed to load requests:', error);
                showStatus('Failed to load authorization requests: ' + error.message, 'error');
                document.getElementById('requestsList').innerHTML = '<p>Error loading requests. Please refresh and try again.</p>';
            }
        }

        // Display authorization requests
        function displayAuthorizationRequests(requests) {
            const container = document.getElementById('requestsList');
            container.innerHTML = '';

            requests.forEach(request => {
                const requestDiv = document.createElement('div');
                requestDiv.className = 'auth-request';
                requestDiv.innerHTML = `
                    <h4>Email Wallet Authorization</h4>
                    <div class="email-preview">
                        <strong>From:</strong> ${request.emailSender || 'Unknown'}<br>
                        <strong>Subject:</strong> ${request.emailSubject || 'Unknown'}<br>
                        <strong>Date:</strong> ${new Date(request.createdAt).toLocaleString()}<br>
                        <strong>Attachments:</strong> ${request.attachmentCount || 0}<br>
                        <strong>Credit Cost:</strong> ${request.creditCost} credits
                    </div>
                    ${request.ipfsHash ? `<p><strong>IPFS Storage:</strong> <a href="https://gateway.pinata.cloud/ipfs/${request.ipfsHash}" target="_blank" class="ipfs-link">${request.ipfsHash}</a></p>` : ''}
                    <p><strong>Request ID:</strong> <code>${request.requestId}</code></p>
                    <p><strong>Expires:</strong> ${new Date(request.expiresAt).toLocaleString()}</p>
                    <p><strong>Status:</strong> <span style="text-transform: capitalize;">${request.status}</span></p>
                    
                    <div style="margin-top: 20px;">
                        ${request.status === 'pending' ? `
                            <button onclick="authorizeRequest('${request.requestId}')" class="button button-primary">
                                Authorize with Enhanced Service
                            </button>
                            <button onclick="rejectRequest('${request.requestId}')" class="button button-danger">
                                Reject
                            </button>
                        ` : `
                            <button class="button" disabled>
                                ${request.status === 'processed' ? 'Wallet Created ✓' : 
                                  request.status === 'authorized' ? 'Authorized ✓' : 
                                  request.status === 'expired' ? 'Expired ❌' : 
                                  request.status.charAt(0).toUpperCase() + request.status.slice(1)}
                            </button>
                        `}
                    </div>
                    
                    <div id="request-status-${request.requestId}"></div>
                `;
                container.appendChild(requestDiv);
            });
        }

        // Authorize request using Enhanced Authorization Service - FIXED
        async function authorizeRequest(requestId) {
            try {
                const statusDiv = document.getElementById(`request-status-${requestId}`);
                statusDiv.innerHTML = '<div class="status status-info"><span class="loading"></span> Creating authorization signature...</div>';

                // Create message hash for signing (consistent with Enhanced Authorization Service)
                const messageHash = ethers.utils.keccak256(
                    ethers.utils.solidityPack(['bytes32'], [requestId])
                );

                // Sign message with MetaMask
                const signature = await signer.signMessage(ethers.utils.arrayify(messageHash));
                
                statusDiv.innerHTML = '<div class="status status-info"><span class="loading"></span> Submitting to Enhanced Authorization Service...</div>';

                // Send signature to Enhanced Authorization Service API
                const response = await fetch(`${API_BASE}/authorization/authorize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requestId,
                        userAddress,
                        signature
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const walletId = result.data?.emailWalletId || result.emailWalletId;
                    const txHash = result.data?.authorizationTx || result.authorizationTx;
                    
                    statusDiv.innerHTML = `
                        <div class="status status-success">
                            ✅ Authorization successful! Email wallet created.<br>
                            ${walletId ? `<strong>Wallet ID:</strong> ${walletId}<br>` : ''}
                            ${txHash ? `<strong>Transaction:</strong> <a href="https://amoy.polygonscan.com/tx/${txHash}" target="_blank">${txHash}</a><br>` : ''}
                            Your EMAIL_DATA_WALLET is now available on the blockchain.
                        </div>
                    `;
                    
                    // Reload requests after successful authorization
                    setTimeout(loadAuthorizationRequests, 3000);
                } else {
                    statusDiv.innerHTML = `<div class="status status-error">Authorization failed: ${result.error}</div>`;
                }

            } catch (error) {
                console.error('Authorization failed:', error);
                const statusDiv = document.getElementById(`request-status-${requestId}`);
                statusDiv.innerHTML = `<div class="status status-error">Authorization failed: ${error.message}</div>`;
            }
        }

        // Reject request using Enhanced Authorization Service - FIXED
        async function rejectRequest(requestId) {
            if (!confirm('Are you sure you want to reject this email wallet creation?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/authorization/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ requestId })
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('Request rejected successfully', 'success');
                    loadAuthorizationRequests();
                } else {
                    showStatus('Failed to reject request: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Failed to reject request:', error);
                showStatus('Failed to reject request: ' + error.message, 'error');
            }
        }

        // Show status message
        function showStatus(message, type) {
            const container = document.getElementById('statusMessages');
            container.innerHTML = `<div class="status status-${type}">${message}</div>`;
        }

        // Clear status messages
        function clearStatus() {
            document.getElementById('statusMessages').innerHTML = '';
        }

        // Event listeners
        document.getElementById('connectWallet').addEventListener('click', connectWallet);

        // Auto-connect if MetaMask already connected
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined' && window.ethereum.selectedAddress) {
                await connectWallet();
            }
        });

        // Handle account changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    updateWalletStatus(false);
                    document.getElementById('requestsList').innerHTML = '<p>Please connect your MetaMask wallet.</p>';
                } else {
                    location.reload(); // Reload to refresh with new account
                }
            });
        }
    </script>
</body>
</html>