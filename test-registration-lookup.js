// test-registration-lookup.js
// Test script to verify the registration lookup fix works
// Run with: node test-registration-lookup.js

const { ethers } = require('ethers');

// Test configuration - using actual deployed contract
const CONFIG = {
    rpcUrl: 'https://rpc-amoy.polygon.technology/',
    registrationContract: '0x71C1d6a0DAB73b25dE970E032bafD42a29dC010F',
    testEmail: 'steven@rivetz.com', // Known registered email
    testWallet: '0x107C5655ce50AB9744Fc36A4e9935E30d4923d0b' // Expected wallet
};

// EmailWalletRegistration ABI - verified functions from deployed contract
const REGISTRATION_ABI = [
    "function isRegistered(address wallet) view returns (bool)",
    "function getRegistration(address wallet) view returns (bytes32 registrationId, string primaryEmail, address parentCorporateWallet, bool autoProcessCC, uint256 registeredAt, bool isActive, uint256 creditBalance)",
    "function getWalletFromEmail(string email) view returns (address)",
    "function isEmailAuthorized(address wallet, string email) view returns (bool)",
    "function getCreditBalance(address wallet) view returns (uint256)",
    "function owner() view returns (address)",
    "function registrationFee() view returns (uint256)"
];

async function testRegistrationLookup() {
    console.log('üß™ TESTING REGISTRATION LOOKUP FIX');
    console.log('=====================================');
    console.log('This test verifies that getWalletFromEmail() function works correctly.');
    console.log('If this passes, the RegistrationLookupService fix should work.');
    console.log('');
    
    try {
        // Initialize provider and contract
        console.log('üì° Connecting to Polygon Amoy...');
        const provider = new ethers.providers.JsonRpcProvider(CONFIG.rpcUrl);
        const contract = new ethers.Contract(CONFIG.registrationContract, REGISTRATION_ABI, provider);
        
        const network = await provider.getNetwork();
        const blockNumber = await provider.getBlockNumber();
        
        console.log(`‚úÖ Connected to ${network.name} (Chain ID: ${network.chainId})`);
        console.log(`‚úÖ Current block: ${blockNumber}`);
        console.log(`‚úÖ Contract: ${CONFIG.registrationContract}`);
        console.log('');
        
        // Test 1: Contract basic functions
        console.log('üîç Test 1: Contract Basic Functions');
        console.log('-----------------------------------');
        try {
            const owner = await contract.owner();
            const registrationFee = await contract.registrationFee();
            console.log(`‚úÖ Contract Owner: ${owner}`);
            console.log(`‚úÖ Registration Fee: ${ethers.utils.formatEther(registrationFee)} POL`);
            
            // Verify service wallet is owner
            const expectedServiceWallet = '0xE2d0E252E7da22901bd1ffDD012Da2c77aC3033a';
            if (owner.toLowerCase() === expectedServiceWallet.toLowerCase()) {
                console.log('‚úÖ Service wallet is contract owner');
            } else {
                console.log(`‚ö†Ô∏è  Owner mismatch - expected ${expectedServiceWallet}, got ${owner}`);
            }
        } catch (error) {
            console.log(`‚ùå Contract basic functions failed: ${error.message}`);
            return;
        }
        console.log('');
        
        // Test 2: Verify test wallet registration
        console.log('üîç Test 2: Test Wallet Registration Status');
        console.log('------------------------------------------');
        try {
            const isRegistered = await contract.isRegistered(CONFIG.testWallet);
            console.log(`üìã Test Wallet: ${CONFIG.testWallet}`);
            console.log(`‚úÖ Is Registered: ${isRegistered}`);
            
            if (isRegistered) {
                const registration = await contract.getRegistration(CONFIG.testWallet);
                console.log(`‚úÖ Primary Email: "${registration.primaryEmail}"`);
                console.log(`‚úÖ Registration ID: ${registration.registrationId}`);
                console.log(`‚úÖ Is Active: ${registration.isActive}`);
                console.log(`‚úÖ Credit Balance: ${registration.creditBalance.toString()}`);
                
                const registeredDate = new Date(registration.registeredAt.toNumber() * 1000);
                console.log(`‚úÖ Registered At: ${registeredDate.toISOString()}`);
                
                // Check if primary email matches test email
                if (registration.primaryEmail.toLowerCase() === CONFIG.testEmail.toLowerCase()) {
                    console.log('‚úÖ Primary email matches test email');
                } else {
                    console.log(`‚ö†Ô∏è  Primary email "${registration.primaryEmail}" != test email "${CONFIG.testEmail}"`);
                }
            } else {
                console.log('‚ùå Test wallet is not registered - email lookup test may fail');
            }
        } catch (error) {
            console.log(`‚ùå Registration check failed: ${error.message}`);
        }
        console.log('');
        
        // Test 3: THE CRITICAL TEST - Email to wallet lookup
        console.log('üîç Test 3: EMAIL TO WALLET LOOKUP');
        console.log('==================================');
        console.log('üéØ THIS IS THE FUNCTION THAT WAS BROKEN IN THE SERVICE');
        console.log('If this returns a wallet address, the fix should work!');
        console.log('');
        
        try {
            console.log(`üìß Looking up email: "${CONFIG.testEmail}"`);
            console.log('üîÑ Calling contract.getWalletFromEmail()...');
            
            const startTime = Date.now();
            const walletFromEmail = await contract.getWalletFromEmail(CONFIG.testEmail);
            const endTime = Date.now();
            
            console.log(`‚è±Ô∏è  Response time: ${endTime - startTime}ms`);
            console.log(`üí∞ Returned wallet: ${walletFromEmail}`);
            
            // Check if result is zero address (no registration)
            if (walletFromEmail === ethers.constants.AddressZero || walletFromEmail === '0x0000000000000000000000000000000000000000') {
                console.log('');
                console.log('‚ùå RESULT: No wallet registered for this email');
                console.log('‚ùå This means:');
                console.log('   ‚Ä¢ Email was never registered, OR');
                console.log('   ‚Ä¢ Email was registered with different case/spacing, OR');
                console.log('   ‚Ä¢ Registration was deactivated');
                console.log('');
                console.log('üîç Try registering the email first or check for case sensitivity issues');
                
            } else {
                console.log('');
                console.log('üéâ SUCCESS: getWalletFromEmail() returned a wallet address!');
                console.log(`‚úÖ Email "${CONFIG.testEmail}" ‚Üí Wallet "${walletFromEmail}"`);
                
                // Verify the returned wallet is actually registered
                const isWalletRegistered = await contract.isRegistered(walletFromEmail);
                console.log(`‚úÖ Returned wallet is registered: ${isWalletRegistered}`);
                
                // Check if it matches expected wallet
                if (walletFromEmail.toLowerCase() === CONFIG.testWallet.toLowerCase()) {
                    console.log('üéØ PERFECT MATCH: Email maps to expected wallet!');
                    console.log('‚úÖ The RegistrationLookupService fix should work correctly');
                } else {
                    console.log(`‚ö†Ô∏è  Email maps to different wallet than expected:`);
                    console.log(`   Expected: ${CONFIG.testWallet}`);
                    console.log(`   Actual:   ${walletFromEmail}`);
                    console.log('   This is still a SUCCESS - the function works!');
                }
                
                // Get credit balance for returned wallet
                try {
                    const credits = await contract.getCreditBalance(walletFromEmail);
                    console.log(`‚úÖ Wallet credit balance: ${credits.toString()}`);
                } catch (error) {
                    console.log(`‚ö†Ô∏è  Could not get credit balance: ${error.message}`);
                }
            }
            
        } catch (error) {
            console.log('');
            console.log(`‚ùå EMAIL LOOKUP FAILED: ${error.message}`);
            console.log(`‚ùå Error code: ${error.code}`);
            
            if (error.code === 'CALL_EXCEPTION') {
                console.log('‚ùå This indicates:');
                console.log('   ‚Ä¢ Contract function doesn\'t exist (unlikely), OR');
                console.log('   ‚Ä¢ Network connectivity issues, OR'); 
                console.log('   ‚Ä¢ Wrong contract address');
            }
        }
        console.log('');
        
        // Test 4: Email authorization check
        console.log('üîç Test 4: Email Authorization Verification');
        console.log('-------------------------------------------');
        try {
            const isAuthorized = await contract.isEmailAuthorized(CONFIG.testWallet, CONFIG.testEmail);
            console.log(`üìß Email: ${CONFIG.testEmail}`);
            console.log(`üí∞ Wallet: ${CONFIG.testWallet}`);
            console.log(`‚úÖ Is Authorized: ${isAuthorized}`);
            
            if (isAuthorized) {
                console.log('‚úÖ Email is properly authorized for wallet');
            } else {
                console.log('‚ùå Email is not authorized for this wallet');
            }
        } catch (error) {
            console.log(`‚ùå Email authorization check failed: ${error.message}`);
        }
        console.log('');
        
        // Summary
        console.log('üìä TEST SUMMARY');
        console.log('================');
        console.log('Contract Connectivity: ‚úÖ Working');
        console.log('Registration Functions: ‚úÖ Working');
        console.log('Email Lookup Function: ' + (walletFromEmail && walletFromEmail !== ethers.constants.AddressZero ? '‚úÖ Working' : '‚ùå No data found'));
        console.log('');
        console.log('üéØ CONCLUSION:');
        if (walletFromEmail && walletFromEmail !== ethers.constants.AddressZero) {
            console.log('‚úÖ The contract getWalletFromEmail() function WORKS!');
            console.log('‚úÖ RegistrationLookupService fix should resolve the null return issue');
            console.log('‚úÖ Email processing pipeline should work after service deployment');
        } else {
            console.log('‚ö†Ô∏è  Contract function works but no data found for test email');
            console.log('‚ö†Ô∏è  May need to register test email or check for case sensitivity');
            console.log('‚úÖ The fix is still valid - service needs to call contract instead of return null');
        }
        
    } catch (error) {
        console.error('‚ùå Test failed with error:', error.message);
        console.error('‚ùå Stack trace:', error.stack);
    }
}

// Run the test
console.log('Starting registration lookup test...');
console.log('');
testRegistrationLookup()
    .then(() => {
        console.log('');
        console.log('Test completed. Check results above.');
        process.exit(0);
    })
    .catch((error) => {
        console.error('Test failed:', error);
        process.exit(1);
    });
